{% extends 'church/base.html' %}
{% load static %}

{% block title %}Calendar & Events - Breaking Barriers International{% endblock %}

{% block content %}
<div class="bg-white py-8 sm:py-16 overflow-x-hidden">
    <div class="container mx-auto px-4 sm:px-6 max-w-[100vw]">
        <!-- Header with month navigation -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 sm:mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold">Calendar & Events</h1>
                <p class="text-gray-600 mt-1">View upcoming meetings, services and special events.</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="?year={{ prev_month_year }}&month={{ prev_month }}"
                    class="inline-flex items-center justify-center px-4 py-3 sm:py-2 min-h-[44px] sm:min-h-0 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-100">
                    &larr; Previous
                </a>
                <div class="text-center">
                    <p class="text-sm uppercase tracking-wide text-gray-500">Month</p>
                    <p class="text-lg font-semibold">{{ current_month_name }} {{ current_year }}</p>
                </div>
                <a href="?year={{ next_month_year }}&month={{ next_month }}"
                    class="inline-flex items-center justify-center px-4 py-3 sm:py-2 min-h-[44px] sm:min-h-0 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-100">
                    Next &rarr;
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left column: Today + upcoming list -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Today summary -->
                <div class="bg-gray-900 text-white rounded-xl p-5 shadow-lg">
                    <p class="text-sm uppercase tracking-wide text-gray-300">Today</p>
                    <p class="text-2xl font-bold mt-1">{% now "F j" %}</p>
                    <p class="text-sm text-gray-300 mt-1">{% now "l" %}</p>
                </div>

                <!-- Upcoming events list -->
                <div class="bg-gray-50 rounded-xl p-5 border border-gray-200 max-h-[480px] overflow-y-auto">
                    <h2 class="text-lg font-semibold mb-3">Upcoming Events</h2>
                    {% if monthly_events %}
                    <ul class="space-y-3">
                        {% for event in monthly_events %}
                        <li class="flex items-start gap-3">
                            <div class="mt-1">
                                <span class="inline-flex h-2 w-2 rounded-full"
                                    style="background-color: {{ event.color }};"></span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-900 cursor-default" title="{{ event.title }}">
                                    {{ event.title }}
                                </p>
                                <p class="text-xs text-gray-500 flex items-center gap-1">
                                    <i class="fas fa-calendar-alt"></i>
                                    {{ event.event_date|date:"D, M j, Y" }}
                                </p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-sm text-gray-500">No events scheduled for this month yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Right column: Month grid (scroll horizontally on very small screens) -->
            <div class="lg:col-span-3 overflow-x-auto -mx-2 px-2 sm:mx-0 sm:px-0">
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden min-w-[280px]">
                    <!-- Weekday header -->
                    <div
                        class="grid grid-cols-7 bg-gray-50 border-b border-gray-200 text-xs font-semibold uppercase tracking-wide text-center text-gray-500">
                        <div class="py-2">Sun</div>
                        <div class="py-2">Mon</div>
                        <div class="py-2">Tue</div>
                        <div class="py-2">Wed</div>
                        <div class="py-2">Thu</div>
                        <div class="py-2">Fri</div>
                        <div class="py-2">Sat</div>
                    </div>

                    <!-- Calendar weeks -->
                    <div class="divide-y divide-gray-200">
                        {% for week in weeks %}
                        <div class="grid grid-cols-7 min-h-[96px]">
                            {% for day in week %}
                            <div class="border-r border-gray-200 last:border-r-0 px-1 py-1 text-xs align-top relative
                                        {% if not day.in_current_month %}bg-gray-50 text-gray-400{% endif %}
                                        {% if day.is_today %}bg-blue-50{% endif %}
                                        {% if day.in_current_month %}cursor-pointer hover:bg-gray-50{% endif %}"
                                onclick="{% if day.in_current_month and not day.events %}showNoEventsMessage('{{ day.date|date:'Y-m-d' }}'){% endif %}"
                                title="{% if day.in_current_month and not day.events %}Click to view date{% endif %}">
                                <div class="flex items-center justify-between mb-1">
                                    <span
                                        class="font-semibold {% if day.is_today %}text-blue-700{% else %}text-gray-700{% endif %}">
                                        {{ day.date.day }}
                                    </span>
                                    {% if day.events %}
                                    <span
                                        class="inline-flex items-center justify-center h-4 w-4 rounded-full bg-brand-color text-white text-[10px]">
                                        {{ day.events|length }}
                                    </span>
                                    {% endif %}
                                </div>

                                {% if day.events %}
                                <div class="space-y-1" onclick="event.stopPropagation();">
                                    {% for event in day.events|slice:":2" %}
                                    <div class="truncate rounded-md px-1.5 py-0.5 text-[11px] text-white transition cursor-pointer hover:opacity-90"
                                        style="background-color: {{ event.color }};"
                                        onclick="viewEventDetails({{ event.id }})"
                                        title="Click to view details: {{ event.title }}">
                                        {{ event.title }}
                                    </div>
                                    {% endfor %}
                                    {% if day.events|length > 2 %}
                                    <p class="text-[10px] text-gray-600 mt-0.5">
                                        +{{ day.events|length|add:"-2" }} more
                                    </p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal (for all users) -->
<div id="eventDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="detailsModalTitle">Event Details</h3>
                <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="eventDetailsContent">
                <!-- Event Image -->
                <div class="mb-4" id="eventImageSection" style="display: none;">
                    <img id="detailsEventImage" src="" alt="Event image"
                        class="w-full h-auto rounded-lg shadow-md object-cover">
                </div>

                <div class="mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div id="detailsColorSwatch" class="w-12 h-12 rounded-md border-2 border-gray-300"
                            style="background-color: #990030;"></div>
                        <div>
                            <h4 id="detailsEventTitle" class="text-lg font-bold text-gray-900"></h4>
                            <p id="detailsEventType" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-sm font-semibold text-gray-700 mb-1">Date</p>
                    <p id="detailsEventDate" class="text-gray-900"></p>
                </div>

                <div class="mb-4" id="locationSection">
                    <p class="text-sm font-semibold text-gray-700 mb-1">Location</p>
                    <p id="detailsEventLocation" class="text-gray-900"></p>
                </div>

                <div class="mb-4">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Description</p>
                    <div id="detailsEventDescription" class="text-gray-700 whitespace-pre-wrap"></div>
                </div>

            </div>

            <div class="mt-4">
                <button onclick="closeDetailsModal()"
                    class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- No Events Modal -->
<div id="noEventsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">No Events</h3>
                <button onclick="closeNoEventsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="text-center py-6">
                <div class="mb-4">
                    <i class="fas fa-calendar-times text-5xl text-gray-300"></i>
                </div>
                <p class="text-gray-700 mb-2" id="noEventsDate"></p>
                <p class="text-gray-500 text-sm">There are no events scheduled for this date.</p>
            </div>

            <div class="mt-4">
                <button onclick="closeNoEventsModal()"
                    class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Event Details Viewing Functions (for all users)
    let detailsEventId = null;

    function viewEventDetails(eventId) {
        // Close any open modals first
        if (document.getElementById('noEventsModal') && !document.getElementById('noEventsModal').classList.contains('hidden')) {
            document.getElementById('noEventsModal').classList.add('hidden');
        }

        detailsEventId = eventId;
        fetch(`/api/calendar-event/${eventId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load event details');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('detailsModalTitle').textContent = 'Event Details';
                document.getElementById('detailsEventTitle').textContent = data.title;
                document.getElementById('detailsEventType').textContent = data.event_type || 'Other';
                document.getElementById('detailsEventDate').textContent = new Date(data.event_date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const locationEl = document.getElementById('detailsEventLocation');
                const locationSection = document.getElementById('locationSection');
                if (data.location && data.location.trim()) {
                    locationEl.textContent = data.location;
                    locationSection.style.display = 'block';
                } else {
                    locationSection.style.display = 'none';
                }

                // Handle event image
                const imageSection = document.getElementById('eventImageSection');
                const eventImage = document.getElementById('detailsEventImage');
                if (data.image_url) {
                    eventImage.src = data.image_url;
                    eventImage.alt = data.title + ' image';
                    imageSection.style.display = 'block';
                } else {
                    imageSection.style.display = 'none';
                }

                document.getElementById('detailsEventDescription').textContent = data.description || 'No description available.';
                document.getElementById('detailsColorSwatch').style.backgroundColor = data.color;
                document.getElementById('eventDetailsModal').classList.remove('hidden');
            })
            .catch(error => {
                alert('Error loading event details: ' + error);
            });
    }

    function closeDetailsModal() {
        document.getElementById('eventDetailsModal').classList.add('hidden');
        detailsEventId = null;
    }

    function showNoEventsMessage(date) {
        // Close any open modals first
        if (document.getElementById('eventDetailsModal') && !document.getElementById('eventDetailsModal').classList.contains('hidden')) {
            document.getElementById('eventDetailsModal').classList.add('hidden');
        }

        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        document.getElementById('noEventsDate').textContent = formattedDate;
        document.getElementById('noEventsModal').classList.remove('hidden');
    }

    function closeNoEventsModal() {
        document.getElementById('noEventsModal').classList.add('hidden');
    }
</script>
{% endblock %}