{% load thumbnail %}
<section class="pt-4 pb-16">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-center mb-6">
            <h2 class="text-3xl md:text-4xl font-bold brand-text">
                <a href="{% url 'gallery' %}" class="hover:underline">
                    Gallery
                </a>
            </h2>
        </div>

        {% if gallery_items %}
        <div x-data="{ active: 0 }" class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
            <!-- List column -->
            <div class="md:col-span-1 space-y-2">
                {% for item in gallery_items %}
                <button type="button"
                    class="w-full flex items-center gap-3 px-3 py-3 border-l-4 rounded-r transition-all"
                    :class="active === {{ forloop.counter0 }} ? 'border-brand-color bg-gray-100 shadow-sm' : 'border-transparent hover:bg-gray-50'"
                    @click="active = {{ forloop.counter0 }}">
                    <div class="flex-shrink-0 w-16 h-10 overflow-hidden bg-black rounded">
                        {% if item.video_url and item.get_youtube_thumbnail_url %}
                        <img src="{{ item.get_youtube_thumbnail_url }}" alt="{{ item.caption }}" loading="lazy"
                            class="w-full h-full object-cover opacity-90" referrerpolicy="no-referrer">
                        {% elif item.image %}
                        {% thumbnail item.image "200x150" crop=True detail=True as thumb %}
                        {% with img_url=thumb.url|default:item.image.url %}
                        <picture>
                            <source srcset="{{ img_url }}.webp" type="image/webp">
                            <img src="{{ img_url }}" alt="{{ item.caption }}" loading="lazy"
                                class="w-full h-full object-cover opacity-90">
                        </picture>
                        {% endwith %}
                        {% else %}
                        <div class="w-full h-full bg-gray-700 flex items-center justify-center">
                            <i class="fas fa-play text-white/60 text-xs"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0 text-left">
                        <p class="text-sm text-gray-800 font-medium leading-tight line-clamp-2">
                            {{ item.caption|striptags }}
                        </p>
                    </div>
                    {% if item.video_url and item.duration_label %}
                    <span class="flex-shrink-0 text-xs text-gray-500 font-medium">
                        {{ item.duration_label }}
                    </span>
                    {% endif %}
                </button>
                {% endfor %}
            </div>

            <!-- Player column -->
            <div class="md:col-span-2">
                {% for item in gallery_items %}
                <div x-show="active === {{ forloop.counter0 }}" x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                    class="w-full rounded-lg overflow-hidden shadow-xl bg-black">
                    {% if item.video_url %}
                    <div class="aspect-video w-full">
                        <iframe class="w-full h-full" src="{{ item.get_embed_url }}" title="{{ item.caption }}"
                            frameborder="0" referrerpolicy="strict-origin-when-cross-origin"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                    {% else %}
                    <div class="aspect-video w-full">
                        {% if item.image_cropping %}
                        {% thumbnail item.image "800x600" box=item.image_cropping crop=True detail=True as cropped %}
                        <picture>
                            <source srcset="{{ cropped.url }}.webp" type="image/webp">
                            <img src="{{ cropped.url }}" alt="{{ item.caption }}" loading="lazy"
                                class="w-full h-full object-contain bg-gray-900">
                        </picture>
                        {% else %}
                        <img src="{{ item.image.url }}" alt="{{ item.caption }}" loading="lazy"
                            class="w-full h-full object-contain bg-gray-900">
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if item.caption %}
                    <div class="bg-gray-900 px-4 py-3">
                        <p class="text-white text-sm font-medium">{{ item.caption|striptags }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="text-center text-gray-500">
            <p>No gallery items have been added yet.</p>
        </div>
        {% endif %}
    </div>
</section>