{% load thumbnail %}
{% load safe_thumbnail %}
<section class="pt-4 pb-16">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-center mb-6">
            <h2 class="text-2xl font-bold brand-text text-center">
                <a href="{% url 'gallery' %}" class="hover:underline">
                    Gallery
                </a>
            </h2>
        </div>

        {% if gallery_items %}
        <div x-data="{
            active: 0,
            total: {{ gallery_items|length }},
            interval: null,
            isRotating: false,
            init() {
                setTimeout(() => {
                    this.startAutoRotate();
                }, 2000);
            },
            startAutoRotate() {
                this.stopAutoRotate();
                this.isRotating = true;
                this.interval = setInterval(() => {
                    if (!this.isRotating) return;
                    this.active = (this.active + 1) % this.total;
                }, 8000); // Rotate every 8 seconds
            },
            stopAutoRotate() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
                this.isRotating = false;
            },
            goTo(index) {
                this.stopAutoRotate();
                this.active = index;
                setTimeout(() => {
                    this.startAutoRotate();
                }, 500);
            }
        }" x-init="init()" @mouseenter="stopAutoRotate()" @mouseleave="startAutoRotate()"
            class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
            <!-- List column -->
            <div class="md:col-span-1 space-y-2">
                {% for item in gallery_items %}
                <button type="button"
                    class="w-full flex items-center gap-3 px-3 py-3 border-l-4 rounded-r transition-all text-left"
                    :class="active === {{ forloop.counter0 }} ? 'border-brand-color bg-gray-100 shadow-sm' : 'border-transparent hover:bg-gray-50'"
                    @click="goTo({{ forloop.counter0 }})">
                    <div class="flex-shrink-0 w-16 h-10 overflow-hidden bg-black rounded">
                        {% if item.video_url and item.get_youtube_thumbnail_url %}
                        <img src="{{ item.get_youtube_thumbnail_url }}" alt="{{ item.caption }}" loading="lazy"
                            class="w-full h-full object-cover opacity-90" referrerpolicy="no-referrer">
                        {% elif item.image %}
                        {% safe_thumbnail item.image "200x150" crop=True detail=True as thumb %}
                        {% if thumb %}
                        {% with img_url=thumb.url %}
                        <picture>
                            <source srcset="{{ img_url }}.webp" type="image/webp">
                            <img src="{{ img_url }}" alt="{{ item.caption }}" loading="lazy"
                                class="w-full h-full object-cover opacity-90">
                        </picture>
                        {% endwith %}
                        {% else %}
                        <div class="w-full h-full bg-gray-700 flex items-center justify-center">
                            <i class="fas fa-image text-white/60 text-xs"></i>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="w-full h-full bg-gray-700 flex items-center justify-center">
                            <i class="fas fa-play text-white/60 text-xs"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0 text-left">
                        <p class="text-sm text-gray-800 font-medium leading-tight line-clamp-2">
                            {{ item.caption|striptags }}
                        </p>
                    </div>
                    {% if item.video_url and item.duration_label %}
                    <span class="flex-shrink-0 text-xs text-gray-500 font-medium">
                        {{ item.duration_label }}
                    </span>
                    {% endif %}
                </button>
                {% endfor %}
            </div>

            <!-- Player column -->
            <div class="md:col-span-2">
                {% for item in gallery_items %}
                <div x-show="active === {{ forloop.counter0 }}" x-transition:enter="transition ease-out duration-500"
                    x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                    class="relative w-full aspect-video rounded-xl overflow-hidden shadow-2xl group border-2"
                    style="background-color: #990030; border-color: #990030;">

                    {% if item.video_url %}
                    <div class="absolute inset-0 w-full h-full">
                        <iframe class="w-full h-full" src="{{ item.get_embed_url }}" title="{{ item.caption }}"
                            frameborder="0" referrerpolicy="strict-origin-when-cross-origin"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                    {% else %}
                    <!-- Background Vibrant Layer (Blurred Backdrop) -->
                    <div class="absolute inset-0 w-full h-full overflow-hidden">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt=""
                            class="w-full h-full object-cover blur-2xl opacity-40 scale-110">
                        {% else %}
                        <div class="w-full h-full bg-gray-800"></div>
                        {% endif %}
                        <div class="absolute inset-0 bg-black/20"></div>
                    </div>

                    <!-- Main Image Preview -->
                    <div class="relative z-10 w-full h-full flex items-center justify-center">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.caption }}"
                            class="max-w-full max-h-full object-contain rounded-lg shadow-lg transition-transform duration-700 group-hover:scale-105">
                        {% else %}
                        <div class="flex flex-col items-center justify-center text-white/60">
                            <i class="fas fa-image text-4xl mb-2"></i>
                            <span class="text-sm">No Image</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Glassmorphism Caption Overlay -->
                    {% if item.caption %}
                    <div
                        class="absolute bottom-0 left-0 right-0 z-20 p-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                        <div
                            class="bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-4 shadow-lg inline-block max-w-[90%]">
                            <p class="text-white text-base font-semibold leading-tight drop-shadow-md">
                                {{ item.caption|striptags }}
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="text-center text-gray-500">
            <p>No gallery items have been added yet.</p>
        </div>
        {% endif %}
    </div>
</section>